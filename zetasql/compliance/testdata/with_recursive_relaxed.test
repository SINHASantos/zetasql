[name=aggregation_in_recursive_term_with_depth]
[default required_features=WITH_RECURSIVE]
[required_features=WITH_RECURSIVE,RELAXED_WITH_RECURSIVE,WITH_RECURSIVE_DEPTH_MODIFIER]
WITH RECURSIVE t AS (
    SELECT 1 AS a, 2 AS b UNION ALL
    SELECT 3 AS a, 4 AS b UNION ALL
    SELECT 5 AS a, 6 AS b
  ), t2 AS (
    SELECT a, b FROM t
    UNION ALL
    SELECT SUM(a), SUM(b) FROM t2
  ) WITH DEPTH BETWEEN 0 AND 3
SELECT * FROM t2 ORDER BY depth, a, b;
--
ARRAY<STRUCT<a INT64, b INT64, depth INT64>>[known order:
  {1, 2, 0},
  {3, 4, 0},
  {5, 6, 0},
  {9, 12, 1},
  {9, 12, 2},
  {9, 12, 3}
]
==
[name=aggregation_in_recursive_term]
[default required_features=WITH_RECURSIVE]
[required_features=WITH_RECURSIVE,RELAXED_WITH_RECURSIVE]
WITH RECURSIVE t AS (
    SELECT 1 AS a, 2 AS b UNION ALL
    SELECT 3 AS a, 4 AS b UNION ALL
    SELECT 5 AS a, 6 AS b
  ), t2 AS (
    SELECT a, b, 0 AS depth FROM t
    UNION ALL
    SELECT a, b, depth FROM (
      SELECT
        MAX(a) AS a, MAX(b) AS b, ANY_VALUE(depth + 1) AS depth, COUNT(*) AS cnt
        FROM t2
      ) WHERE cnt > 1
  )
SELECT * FROM t2 ORDER BY depth, a, b;
--
ARRAY<STRUCT<a INT64, b INT64, depth INT64>>[known order:
  {1, 2, 0},
  {3, 4, 0},
  {5, 6, 0},
  {5, 6, 1}
]
==
[name=aggregation_in_recursive_term_group_by]
[required_features=WITH_RECURSIVE,RELAXED_WITH_RECURSIVE,WITH_RECURSIVE_DEPTH_MODIFIER]
WITH RECURSIVE t AS (
    SELECT 1 AS a, 2 AS b UNION ALL
    SELECT 6 AS a, 2 AS b UNION ALL
    SELECT 3 AS a, 4 AS b UNION ALL
    SELECT 5 AS a, 4 AS b
  ), t2 AS (
    SELECT a, b FROM t
    UNION ALL
    SELECT SUM(a), b FROM t2 GROUP BY b
  ) WITH DEPTH BETWEEN 0 AND 3
SELECT * FROM t2;
--
ARRAY<STRUCT<a INT64, b INT64, depth INT64>>[unknown order:
  {3, 4, 0},
  {1, 2, 0},
  {5, 4, 0},
  {6, 2, 0},
  {8, 4, 1},
  {7, 2, 1},
  {8, 4, 2},
  {7, 2, 2},
  {8, 4, 3},
  {7, 2, 3}
]
==
[name=distinct_in_recursive_term]
[required_features=WITH_RECURSIVE,RELAXED_WITH_RECURSIVE,WITH_RECURSIVE_DEPTH_MODIFIER]
WITH RECURSIVE t AS (
    SELECT 1 AS a, 2 AS b UNION ALL
    SELECT 1 AS a, 2 AS b UNION ALL
    SELECT 3 AS a, 4 AS b UNION ALL
    SELECT 3 AS a, 4 AS b
  ), t2 AS (
    SELECT a, b FROM t
    UNION ALL
    SELECT DISTINCT a, b FROM t2
  ) WITH DEPTH BETWEEN 0 AND 3
SELECT * FROM t2;
--
ARRAY<STRUCT<a INT64, b INT64, depth INT64>>[unknown order:
  {3, 4, 0},
  {1, 2, 0},
  {3, 4, 0},
  {1, 2, 0},
  {3, 4, 1},
  {1, 2, 1},
  {3, 4, 2},
  {1, 2, 2},
  {3, 4, 3},
  {1, 2, 3}
]
==
[name=analytic_in_recursive_term_group_by]
[required_features=WITH_RECURSIVE,RELAXED_WITH_RECURSIVE,WITH_RECURSIVE_DEPTH_MODIFIER,ANALYTIC_FUNCTIONS]
WITH RECURSIVE t AS (
    SELECT 1 AS a, 2 AS b UNION ALL
    SELECT 6 AS a, 2 AS b UNION ALL
    SELECT 3 AS a, 4 AS b UNION ALL
    SELECT 5 AS a, 4 AS b
  ), t2 AS (
    SELECT a, b FROM t
    UNION ALL
    SELECT ROW_NUMBER() OVER (PARTITION BY b ORDER BY a) AS a, b FROM t2
  ) WITH DEPTH BETWEEN 0 AND 2
SELECT * FROM t2 ORDER BY depth, b, a;
--
ARRAY<STRUCT<a INT64, b INT64, depth INT64>>[known order:
  {1, 2, 0},
  {6, 2, 0},
  {3, 4, 0},
  {5, 4, 0},
  {1, 2, 1},
  {2, 2, 1},
  {1, 4, 1},
  {2, 4, 1},
  {1, 2, 2},
  {2, 2, 2},
  {1, 4, 2},
  {2, 4, 2}
]
==
[name=multiple_recursive_refs]
[required_features=WITH_RECURSIVE,RELAXED_WITH_RECURSIVE,WITH_RECURSIVE_DEPTH_MODIFIER]
WITH RECURSIVE t AS (
    SELECT 1 AS a, 2 AS b UNION ALL
    SELECT 1 AS a, 2 AS b
  ), t2 AS (
    SELECT a, b FROM t
    UNION ALL (
      SELECT a + 10, b + 1 FROM t2
      UNION ALL
      SELECT a + 100, b + 100 FROM t2
    )
  ) WITH DEPTH BETWEEN 0 AND 2
SELECT * FROM t2;
--
ARRAY<STRUCT<a INT64, b INT64, depth INT64>>[unknown order:
  {1, 2, 0},
  {1, 2, 0},
  {101, 102, 1},
  {11, 3, 1},
  {101, 102, 1},
  {11, 3, 1},
  {111, 103, 2},
  {201, 202, 2},
  {111, 103, 2},
  {201, 202, 2},
  {21, 4, 2},
  {111, 103, 2},
  {21, 4, 2},
  {111, 103, 2}
]
==
[name=cte_right_operand_of_left_join]
[required_features=WITH_RECURSIVE,RELAXED_WITH_RECURSIVE,WITH_RECURSIVE_DEPTH_MODIFIER]
WITH RECURSIVE
  t1 AS (
    SELECT 1 AS a, 2 AS b UNION ALL
    SELECT 3 AS a, 4 AS b
  ), t2 AS (
    SELECT 1 AS a, 12 AS b UNION ALL
    SELECT 13 AS a, 18 AS b
  ), t3 AS (
    SELECT a, b FROM t1
    UNION ALL
      SELECT t3.a + 10, t2.b * 1000 + t3.b
      FROM t2 LEFT JOIN t3 USING(a)
  ) WITH DEPTH BETWEEN 0 AND 2
SELECT * FROM t3
ORDER BY depth, a, b;
--
ARRAY<STRUCT<a INT64, b INT64, depth INT64>>[known order:
  {1, 2, 0},
  {3, 4, 0},
  {NULL, NULL, 1},
  {11, 12002, 1},
  {NULL, NULL, 2},
  {NULL, NULL, 2}
]
==
[name=cte_left_operand_of_right_join]
[required_features=WITH_RECURSIVE,RELAXED_WITH_RECURSIVE,WITH_RECURSIVE_DEPTH_MODIFIER]
WITH RECURSIVE
  t1 AS (
    SELECT 1 AS a, 2 AS b UNION ALL
    SELECT 3 AS a, 4 AS b
  ), t2 AS (
    SELECT 1 AS a, 12 AS b UNION ALL
    SELECT 13 AS a, 18 AS b
  ), t3 AS (
    SELECT a, b FROM t1
    UNION ALL
      SELECT t3.a + 10, t2.b * 1000 + t3.b
      FROM t3 RIGHT JOIN t2 USING(a)
  ) WITH DEPTH BETWEEN 0 AND 2
SELECT * FROM t3
ORDER BY depth, a, b;
--
ARRAY<STRUCT<a INT64, b INT64, depth INT64>>[known order:
  {1, 2, 0},
  {3, 4, 0},
  {NULL, NULL, 1},
  {11, 12002, 1},
  {NULL, NULL, 2},
  {NULL, NULL, 2}
]
==
[name=cte_operand_of_full_join]
[required_features=WITH_RECURSIVE,RELAXED_WITH_RECURSIVE,WITH_RECURSIVE_DEPTH_MODIFIER]
WITH RECURSIVE
  t1 AS (
    SELECT 1 AS a, 2 AS b UNION ALL
    SELECT 3 AS a, 4 AS b
  ), t2 AS (
    SELECT 1 AS a, 12 AS b UNION ALL
    SELECT 13 AS a, 18 AS b
  ), t3 AS (
    SELECT a, b FROM t1
    UNION ALL
      SELECT t3.a + 10, t2.b * 1000 + t3.b
      FROM t2 FULL OUTER JOIN t3 USING(a)
  ) WITH DEPTH BETWEEN 0 AND 2
SELECT * FROM t3
ORDER BY depth, a, b;
--
ARRAY<STRUCT<a INT64, b INT64, depth INT64>>[known order:
  {1, 2, 0},
  {3, 4, 0},
  {NULL, NULL, 1},
  {11, 12002, 1},
  {13, NULL, 1},
  {NULL, NULL, 2},
  {NULL, NULL, 2},
  {21, NULL, 2},
  {23, NULL, 2}
]
