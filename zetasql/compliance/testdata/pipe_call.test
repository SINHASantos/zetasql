[default required_features=TABLE_VALUED_FUNCTIONS,CREATE_TABLE_FUNCTION,TEMPLATE_FUNCTIONS,PIPES]

[prepare_database]
CREATE TABLE t1 AS
  SELECT * FROM UNNEST([
    STRUCT(1 AS rowid, 1 AS x),
    STRUCT(2 AS rowid, 1 AS x),
    STRUCT(3 AS rowid, 2 AS x),
    STRUCT(4 AS rowid, 2 AS x)]);
--
ARRAY<STRUCT<rowid INT64, x INT64>>[{2, 1}, {4, 2}, {1, 1}, {3, 2}]
==

[prepare_database]
CREATE TABLE t2 AS
  SELECT * FROM UNNEST([
    STRUCT(5 AS rowid, 3 AS x),
    STRUCT(6 AS rowid, 3 AS x),
    STRUCT(7 AS rowid, 4 AS x),
    STRUCT(8 AS rowid, 5 AS x)]);
--
ARRAY<STRUCT<rowid INT64, x INT64>>[{6, 3}, {8, 5}, {5, 3}, {7, 4}]
==

[prepare_database]
CREATE TABLE FUNCTION tvf_add_column(t ANY TABLE)
AS (
  FROM t
  |> EXTEND "added" AS added_column
)
==

[prepare_database]
CREATE TABLE FUNCTION tvf_union2(arg1 ANY TABLE, arg2 ANY TABLE)
AS (
  SELECT "arg1" AS source_table, * FROM arg1
  UNION ALL
  SELECT "arg2", * FROM arg2
)
==

[name=tvf_call]
FROM t1
|> CALL tvf_add_column()
--
ARRAY<STRUCT<rowid INT64, x INT64, added_column STRING>>[unknown order:
  {1, 1, "added"},
  {2, 1, "added"},
  {3, 2, "added"},
  {4, 2, "added"}
]
==

[required_features=TABLE_VALUED_FUNCTIONS,CREATE_TABLE_FUNCTION,TEMPLATE_FUNCTIONS,PIPES,PIPE_CALL_INPUT_TABLE]
[name=tvf_call_with_input_table]
FROM t1
|> CALL tvf_add_column(INPUT TABLE)
--
ARRAY<STRUCT<rowid INT64, x INT64, added_column STRING>>[unknown order:
  {1, 1, "added"},
  {2, 1, "added"},
  {3, 2, "added"},
  {4, 2, "added"}
]
==

[name=tvf_call_two_tables]
FROM t1
|> CALL tvf_union2( TABLE t2 )
|> ORDER BY 1,2
--
ARRAY<STRUCT<source_table STRING, rowid INT64, x INT64>>[known order:
  {"arg1", 1, 1},
  {"arg1", 2, 1},
  {"arg1", 3, 2},
  {"arg1", 4, 2},
  {"arg2", 5, 3},
  {"arg2", 6, 3},
  {"arg2", 7, 4},
  {"arg2", 8, 5}
]
==

[required_features=TABLE_VALUED_FUNCTIONS,CREATE_TABLE_FUNCTION,TEMPLATE_FUNCTIONS,PIPES,PIPE_CALL_INPUT_TABLE]
[name=tvf_call_two_tables_input_table_first]
FROM t1
|> CALL tvf_union2( INPUT TABLE, TABLE t2 )
|> ORDER BY 1,2
--
ARRAY<STRUCT<source_table STRING, rowid INT64, x INT64>>[known order:
  {"arg1", 1, 1},
  {"arg1", 2, 1},
  {"arg1", 3, 2},
  {"arg1", 4, 2},
  {"arg2", 5, 3},
  {"arg2", 6, 3},
  {"arg2", 7, 4},
  {"arg2", 8, 5}
]
==

[required_features=TABLE_VALUED_FUNCTIONS,CREATE_TABLE_FUNCTION,TEMPLATE_FUNCTIONS,PIPES,PIPE_CALL_INPUT_TABLE]
[name=tvf_call_two_tables_input_table_second]
FROM t2
|> CALL tvf_union2( TABLE t1, INPUT TABLE )
|> ORDER BY 1,2
--
ARRAY<STRUCT<source_table STRING, rowid INT64, x INT64>>[known order:
  {"arg1", 1, 1},
  {"arg1", 2, 1},
  {"arg1", 3, 2},
  {"arg1", 4, 2},
  {"arg2", 5, 3},
  {"arg2", 6, 3},
  {"arg2", 7, 4},
  {"arg2", 8, 5}
]
==

[required_features=TABLE_VALUED_FUNCTIONS,CREATE_TABLE_FUNCTION,TEMPLATE_FUNCTIONS,PIPES,PIPE_CALL_INPUT_TABLE,NAMED_ARGUMENTS]
[name=tvf_call_two_tables_input_table_named_args]
FROM t1
|> CALL tvf_union2( arg2=>(SELECT * FROM t2), arg1=>INPUT TABLE )
|> ORDER BY 1,2
--
ARRAY<STRUCT<source_table STRING, rowid INT64, x INT64>>[known order:
  {"arg1", 1, 1},
  {"arg1", 2, 1},
  {"arg1", 3, 2},
  {"arg1", 4, 2},
  {"arg2", 5, 3},
  {"arg2", 6, 3},
  {"arg2", 7, 4},
  {"arg2", 8, 5}
]
